@page "/admin/transactions/withdrawal"
@page "/employee/transactions/withdrawal"
@layout AdminLayout

<div class="section-header">
    <h2 class="section-title">üí∏ Withdrawal Transaction</h2>
    <p style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">
        Process customer withdrawals - ATM, Teller, or Online
    </p>
</div>

<!-- Multi-Step Progress -->
<div style="background: white; border-radius: 16px; padding: 24px; border: 1px solid var(--border); margin-bottom: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center; position: relative;">
        @for (int i = 1; i <= 3; i++)
        {
            var isActive = currentStep == i;
            var isCompleted = currentStep > i;
            
            <div style="flex: 1; text-align: center; position: relative; z-index: 1;">
                <div style="display: inline-flex; align-items: center; justify-content: center; width: 48px; height: 48px; border-radius: 50%; background: @(isActive ? "#ef4444" : isCompleted ? "#10b981" : "#e5e7eb"); color: @(isActive || isCompleted ? "white" : "#6b7280"); font-weight: 700; font-size: 18px; margin-bottom: 8px;">
                    @if (isCompleted)
                    {
                        <span>‚úì</span>
                    }
                    else
                    {
                        <span>@i</span>
                    }
                </div>
                <div style="font-size: 13px; font-weight: 600; color: @(isActive ? "#ef4444" : isCompleted ? "#10b981" : "#6b7280");">
                    @(i == 1 ? "Transaction Details" : i == 2 ? "ID Verification & Auth" : "Confirmation")
                </div>
            </div>
            
            @if (i < 3)
            {
                <div style="flex: 1; height: 2px; background: @(currentStep > i ? "#10b981" : "#e5e7eb"); position: relative; top: -24px;"></div>
            }
        }
    </div>
</div>

<!-- Step 1: Transaction Details -->
@if (currentStep == 1)
{
    <div style="background: white; border-radius: 16px; padding: 32px; border: 1px solid var(--border);">
        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 24px; display: flex; align-items: center; gap: 8px;">
            <span>üìù</span> Step 1: Enter Withdrawal Information
        </h3>

        <form>
            <!-- Transaction Information -->
            <div style="margin-bottom: 32px;">
                <h4 style="font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 16px; background: #fef2f2; padding: 12px; border-radius: 8px; color: #991b1b;">
                    üìã Transaction Information
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label required-field">Transaction ID</label>
                        <input type="text" class="form-control" @bind="transactionId" readonly 
                               style="background: #f3f4f6; font-family: monospace; font-weight: 700;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label required-field">Transaction Date & Time</label>
                        <input type="datetime-local" class="form-control" @bind="transactionDateTime" />
                    </div>

                    <div class="form-group">
                        <label class="form-label required-field">Withdrawal Method</label>
                        <select class="form-control" @bind="withdrawalMethod">
                            <option value="">Select withdrawal method...</option>
                            <option value="ATM">üèß ATM Withdrawal</option>
                            <option value="Teller">üë§ Over-the-Counter (Teller)</option>
                            <option value="Online">üåê Online Transfer</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label required-field">Reference Number</label>
                        <input type="text" class="form-control" @bind="referenceNumber" 
                               placeholder="REF-XXXX" />
                    </div>

                    @if (withdrawalMethod == "Teller")
                    {
                        <div class="form-group">
                            <label class="form-label required-field">Withdrawal Slip Number</label>
                            <input type="text" class="form-control" @bind="withdrawalSlipNumber" 
                                   placeholder="WS-XXXXXXXXXX" />
                        </div>
                    }

                    <div class="form-group">
                        <label class="form-label required-field">Status</label>
                        <select class="form-control" @bind="status">
                            <option value="Pending">‚è≥ Pending</option>
                            <option value="Processing">üîÑ Processing</option>
                            <option value="Completed">‚úÖ Completed</option>
                            <option value="Failed">‚ùå Failed</option>
                            <option value="Declined">üö´ Declined</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Account Information -->
            <div style="margin-bottom: 32px;">
                <h4 style="font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 16px; background: #fef2f2; padding: 12px; border-radius: 8px; color: #991b1b;">
                    üë§ Account Information
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label required-field">Account Number</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" class="form-control" @bind="accountNumber" 
                                   placeholder="BFAS-XXXXXXXXXXXX" 
                                   style="font-family: monospace;" />
                            <button type="button" class="btn" style="background: #ef4444; color: white; padding: 0 16px;">
                                üîç
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Account Holder Name</label>
                        <input type="text" class="form-control" value="Maria Santos" readonly 
                               style="background: #f3f4f6;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Current Balance</label>
                        <input type="text" class="form-control" value="‚Ç±125,450.75" readonly 
                               style="background: #f3f4f6; font-weight: 700; color: #10b981;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Available Balance</label>
                        <input type="text" class="form-control" value="‚Ç±125,450.75" readonly 
                               style="background: #f3f4f6; font-weight: 700; color: #10b981;" />
                    </div>
                </div>
            </div>

            <!-- Amount & Purpose -->
            <div style="margin-bottom: 32px;">
                <h4 style="font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 16px; background: #fef2f2; padding: 12px; border-radius: 8px; color: #991b1b;">
                    üíµ Withdrawal Amount & Purpose
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label required-field">Withdrawal Amount (‚Ç±)</label>
                        <input type="number" class="form-control" @bind="amount" 
                               @oninput="CheckWithdrawalLimit"
                               placeholder="0.00" step="0.01" min="0"
                               style="font-size: 18px; font-weight: 700; color: #ef4444;" />
                        <span class="form-help">Amount to be withdrawn</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Transaction Fee (‚Ç±)</label>
                        <input type="number" class="form-control" @bind="transactionFee" 
                               placeholder="0.00" step="0.01" readonly
                               style="background: #f3f4f6;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label required-field">Purpose/Reason</label>
                        <select class="form-control" @bind="purpose">
                            <option value="">Select purpose...</option>
                            <option value="Personal Use">üí∞ Personal Use</option>
                            <option value="Bill Payment">üìÑ Bill Payment</option>
                            <option value="Business">üè¢ Business Expense</option>
                            <option value="Emergency">üö® Emergency</option>
                            <option value="Shopping">üõí Shopping</option>
                            <option value="Medical">üè• Medical</option>
                            <option value="Other">üìù Other</option>
                        </select>
                    </div>

                    @if (purpose == "Other")
                    {
                        <div class="form-group">
                            <label class="form-label">Specify Purpose</label>
                            <input type="text" class="form-control" @bind="purposeOther" 
                                   placeholder="Please specify..." />
                        </div>
                    }

                    <div class="form-group">
                        <label class="form-label">Daily Withdrawal Limit</label>
                        <input type="text" class="form-control" value="‚Ç±50,000.00" readonly 
                               style="background: #f3f4f6;" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Remaining Limit Today</label>
                        <input type="text" class="form-control" value="‚Ç±@remainingLimit.ToString("N2")" readonly 
                               style="background: @(remainingLimit > 10000 ? "#d1fae5" : "#fee2e2"); font-weight: 700; color: @(remainingLimit > 10000 ? "#065f46" : "#991b1b");" />
                    </div>
                </div>

                <!-- Limit Warning -->
                @if (amount > remainingLimit)
                {
                    <div style="background: #fee2e2; border: 2px solid #fecaca; border-radius: 12px; padding: 16px; margin-top: 16px; color: #991b1b;">
                        <div style="font-weight: 700; margin-bottom: 4px;">‚ö†Ô∏è Daily Limit Exceeded</div>
                        <div style="font-size: 13px;">
                            This withdrawal exceeds your daily limit. Manager approval is required.
                        </div>
                    </div>
                }

                <!-- Amount Summary Box -->
                <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; padding: 20px; margin-top: 20px; color: white;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
                        <div>
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">Withdrawal Amount</div>
                            <div style="font-size: 24px; font-weight: 700;">‚Ç±@amount.ToString("N2")</div>
                        </div>
                        <div style="border-left: 1px solid rgba(255,255,255,0.3); border-right: 1px solid rgba(255,255,255,0.3);">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">Transaction Fee</div>
                            <div style="font-size: 24px; font-weight: 700;">‚Ç±@transactionFee.ToString("N2")</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 4px;">Total Deduction</div>
                            <div style="font-size: 24px; font-weight: 700;">‚Ç±@((amount + transactionFee).ToString("N2"))</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing Details -->
            <div style="margin-bottom: 32px;">
                <h4 style="font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 16px; background: #fef2f2; padding: 12px; border-radius: 8px; color: #991b1b;">
                    üè¢ Processing Details
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label class="form-label">Branch/Location</label>
                        <select class="form-control" @bind="branchLocation">
                            <option value="Main Branch">Main Branch</option>
                            <option value="Makati Branch">Makati Branch</option>
                            <option value="BGC Branch">BGC Branch</option>
                            <option value="Quezon City Branch">Quezon City Branch</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Authorized By (Employee)</label>
                        <input type="text" class="form-control" value="Carlos Mendoza (EMP-2045)" readonly 
                               style="background: #f3f4f6;" />
                    </div>
                </div>
            </div>

            <!-- Notes & Remarks -->
            <div style="margin-bottom: 32px;">
                <h4 style="font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 16px; background: #fef2f2; padding: 12px; border-radius: 8px; color: #991b1b;">
                    üìÑ Additional Notes
                </h4>
                
                <div class="form-group">
                    <label class="form-label">Transaction Notes</label>
                    <textarea class="form-control" @bind="notes" rows="3" 
                              placeholder="Enter any additional notes or remarks..."></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 2px solid var(--border);">
                <button type="button" class="btn" style="background: #f3f4f6; color: #374151; padding: 12px 24px; border-radius: 12px; font-weight: 600;">
                    ‚Ü∫ Reset
                </button>
                <button type="button" class="btn" style="background: #ef4444; color: white; padding: 12px 32px; border-radius: 12px; font-weight: 600;" @onclick="() => currentStep = 2">
                    Next Step ‚Üí
                </button>
            </div>
        </form>
    </div>
}

<!-- Step 2: ID Verification -->
@if (currentStep == 2)
{
    <div style="background: white; border-radius: 16px; padding: 32px; border: 1px solid var(--border);">
        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 24px; display: flex; align-items: center; gap: 8px;">
            <span>ü™™</span> Step 2: Identity Verification & Authorization
        </h3>

        <!-- ID Verification Section -->
        <div style="margin-bottom: 32px;">
            <h4 style="font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 16px; background: #fef3c7; padding: 12px; border-radius: 8px; color: #92400e;">
                ü™™ Customer Identification
            </h4>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label class="form-label required-field">ID Type</label>
                    <select class="form-control" @bind="idType">
                        <option value="">Select ID type...</option>
                        <option value="Government ID">üèõÔ∏è Government Issued ID</option>
                        <option value="Passport">üõÇ Passport</option>
                        <option value="Drivers License">üöó Driver's License</option>
                        <option value="UMID">üÜî UMID</option>
                        <option value="SSS">üìã SSS ID</option>
                        <option value="Postal ID">üìÆ Postal ID</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label required-field">ID Number</label>
                    <input type="text" class="form-control" @bind="idNumber" 
                           placeholder="Enter ID number" />
                </div>

                <div class="form-group">
                    <label class="form-label">ID Issued Date</label>
                    <input type="date" class="form-control" @bind="idIssuedDate" />
                </div>

                <div class="form-group">
                    <label class="form-label">ID Expiry Date</label>
                    <input type="date" class="form-control" @bind="idExpiryDate" />
                </div>
            </div>

            <!-- ID Verification Checklist -->
            <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px; padding: 20px; margin-top: 20px;">
                <div style="font-weight: 700; margin-bottom: 12px; color: #92400e;">‚ö†Ô∏è ID Verification Checklist</div>
                <div style="display: grid; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" @bind="verifyIdValid" />
                        <span style="font-size: 14px;">‚úì ID is valid and not expired</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" @bind="verifyIdMatches" />
                        <span style="font-size: 14px;">‚úì Photo and details match the customer</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" @bind="verifySignatureMatches" />
                        <span style="font-size: 14px;">‚úì Customer signature verified</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" @bind="verifyBalanceSufficient" />
                        <span style="font-size: 14px;">‚úì Account balance is sufficient</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Transaction Summary -->
        <div style="background: #fef2f2; border: 2px solid #fecaca; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
            <div style="font-weight: 700; margin-bottom: 16px; color: #991b1b;">üìä Transaction Summary</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Account Number</div>
                    <div style="font-weight: 700; font-family: monospace;">@accountNumber</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Withdrawal Amount</div>
                    <div style="font-weight: 700; font-size: 20px; color: #ef4444;">‚Ç±@amount.ToString("N2")</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Current Balance</div>
                    <div style="font-weight: 700; color: #10b981;">‚Ç±125,450.75</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Balance After Withdrawal</div>
                    <div style="font-weight: 700; color: #f59e0b;">‚Ç±@((125450.75m - amount - transactionFee).ToString("N2"))</div>
                </div>
            </div>
        </div>

        <!-- OTP Authorization -->
        <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
            <div style="font-weight: 700; margin-bottom: 12px; color: #1e40af;">üîê Enter Transaction PIN/OTP</div>
            <div style="display: flex; gap: 12px; align-items: flex-end;">
                <div class="form-group" style="flex: 1; margin: 0;">
                    <input type="password" class="form-control" @bind="transactionOTP" 
                           placeholder="Enter 6-digit OTP" maxlength="6"
                           style="font-size: 18px; letter-spacing: 8px; text-align: center; font-weight: 700;" />
                </div>
                <button type="button" class="btn" style="background: #3b82f6; color: white; padding: 12px 20px; border-radius: 8px; font-size: 13px; font-weight: 600;">
                    üì± Resend OTP
                </button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 12px; justify-content: space-between; padding-top: 20px; border-top: 2px solid var(--border);">
            <button type="button" class="btn" style="background: #f3f4f6; color: #374151; padding: 12px 24px; border-radius: 12px; font-weight: 600;" @onclick="() => currentStep = 1">
                ‚Üê Back
            </button>
            <button type="button" class="btn" style="background: #ef4444; color: white; padding: 12px 32px; border-radius: 12px; font-weight: 600;" 
                    @onclick="() => currentStep = 3"
                    disabled="@(!AllVerificationsPassed)">
                Authorize & Process ‚Üí
            </button>
        </div>
    </div>
}

<!-- Step 3: Confirmation -->
@if (currentStep == 3)
{
    <div style="background: white; border-radius: 16px; padding: 32px; border: 1px solid var(--border); text-align: center;">
        <div style="font-size: 80px; margin-bottom: 20px;">‚úÖ</div>
        <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 12px; color: #10b981;">
            Withdrawal Processed Successfully!
        </h3>
        <p style="color: var(--text-secondary); font-size: 15px; margin-bottom: 32px;">
            The withdrawal has been processed and debited from the account.
        </p>

        <!-- Transaction Receipt -->
        <div style="background: #f9fafb; border-radius: 12px; padding: 24px; max-width: 500px; margin: 0 auto 32px; text-align: left;">
            <div style="text-align: center; font-weight: 700; font-size: 16px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px dashed #d1d5db;">
                WITHDRAWAL RECEIPT
            </div>
            
            <div style="display: grid; gap: 12px;">
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">Transaction ID:</span>
                    <span style="font-weight: 700; font-family: monospace;">@transactionId</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">Date & Time:</span>
                    <span style="font-weight: 600;">@transactionDateTime.ToString("MMM dd, yyyy hh:mm tt")</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">Account:</span>
                    <span style="font-weight: 700; font-family: monospace;">@accountNumber</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">Method:</span>
                    <span style="font-weight: 600;">@withdrawalMethod</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 12px; margin-top: 12px; border-top: 2px dashed #d1d5db;">
                    <span style="color: var(--text-secondary);">Amount Withdrawn:</span>
                    <span style="font-weight: 700; font-size: 20px; color: #ef4444;">‚Ç±@amount.ToString("N2")</span>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button type="button" class="btn" style="background: #f3f4f6; color: #374151; padding: 12px 24px; border-radius: 12px; font-weight: 600;">
                üñ®Ô∏è Print Receipt
            </button>
            <button type="button" class="btn" style="background: #dbeafe; color: #1e40af; padding: 12px 24px; border-radius: 12px; font-weight: 600;">
                üìß Email Receipt
            </button>
            <button type="button" class="btn" style="background: #ef4444; color: white; padding: 12px 32px; border-radius: 12px; font-weight: 600;" @onclick="ResetTransaction">
                ‚ûï New Transaction
            </button>
        </div>
    </div>
}

@code {
    private int currentStep = 1;

    // Transaction Details
    private string transactionId = $"TXN-WD-{DateTime.Now:yyyyMMddHHmmss}";
    private DateTime transactionDateTime = DateTime.Now;
    private string withdrawalMethod = "";
    private string referenceNumber = "";
    private string withdrawalSlipNumber = "";
    private string status = "Pending";

    // Account Information
    private string accountNumber = "";
    private decimal remainingLimit = 50000.00m;

    // Amount & Purpose
    private decimal amount = 0;
    private decimal transactionFee = 0;
    private string purpose = "";
    private string purposeOther = "";
    private string branchLocation = "Main Branch";

    // ID Verification
    private string idType = "";
    private string idNumber = "";
    private DateTime idIssuedDate = DateTime.Now;
    private DateTime idExpiryDate = DateTime.Now.AddYears(5);

    // Verification Checkboxes
    private bool verifyIdValid = false;
    private bool verifyIdMatches = false;
    private bool verifySignatureMatches = false;
    private bool verifyBalanceSufficient = false;
    private string transactionOTP = "";

    // Notes
    private string notes = "";

    private bool AllVerificationsPassed => 
        verifyIdValid && verifyIdMatches && verifySignatureMatches && verifyBalanceSufficient && !string.IsNullOrEmpty(transactionOTP);

    private void CheckWithdrawalLimit()
    {
        // Calculate remaining limit after this withdrawal
        remainingLimit = 50000.00m - amount;
    }

    private void ResetTransaction()
    {
        currentStep = 1;
        transactionId = $"TXN-WD-{DateTime.Now:yyyyMMddHHmmss}";
        transactionDateTime = DateTime.Now;
        withdrawalMethod = "";
        accountNumber = "";
        amount = 0;
        purpose = "";
        notes = "";
        verifyIdValid = false;
        verifyIdMatches = false;
        verifySignatureMatches = false;
        verifyBalanceSufficient = false;
        transactionOTP = "";
    }
}
